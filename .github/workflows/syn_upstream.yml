name: Sync Upstream

on:
  schedule:
    - cron: '0 * * * *'   # 每小时运行一次
  workflow_dispatch:

concurrency:
  group: dashboard-ci-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  UPSTREAM_REPO: 'astrbotdevs/astrbot'
  UPSTREAM_BRANCH: 'master'
  TARGET_BRANCH: 'master'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout downstream (use PAT so pushes succeed)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Ensure jq present (used for JSON parsing)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Add upstream remote and fetch
        run: |
          set -e
          UPSTREAM_URL="https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "${UPSTREAM_URL}"
          git fetch --no-tags --prune upstream "${{ env.UPSTREAM_BRANCH }}"

      - name: Create branch from upstream and push to origin
        id: create_branch
        run: |
          set -e
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BRANCH_NAME="sync-upstream-${TIMESTAMP}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # Create a local branch that points to upstream/<branch>
          git checkout -b "${BRANCH_NAME}" "upstream/${{ env.UPSTREAM_BRANCH }}"

          # Push branch to downstream origin using the token provided to checkout
          git push --set-upstream origin "${BRANCH_NAME}"

          echo "Pushed ${BRANCH_NAME} to origin"

      - name: Create PR via GitHub API if not exists
        id: create_pr
        env:
          GITHUB_API: https://api.github.com
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          BRANCH: ${{ steps.create_branch.outputs.BRANCH_NAME }}
          BASE: ${{ env.TARGET_BRANCH }}
          PAT: ${{ secrets.PAT }}
        run: |
          set -e
          git fetch --no-tags --prune origin "${BASE}" || true
          if ! git show-ref --verify --quiet "refs/remotes/origin/${BASE}"; then
            echo "警告：无法获取 origin/${BASE}，将继续尝试创建 PR（但这可能失败）"
          fi

          AHEAD_COUNT=$(git rev-list --count "origin/${BASE}..${BRANCH}" 2>/dev/null || echo "0")
          echo "ahead_count=${AHEAD_COUNT}"
          if [ "${AHEAD_COUNT}" -eq 0 ]; then
            echo "No commits between ${BASE} and ${BRANCH} -> skip creating PR."
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PRS_JSON=$(curl -s -H "Authorization: token ${PAT}" \
            "${GITHUB_API}/repos/${REPO}/pulls?head=${OWNER}:${BRANCH}&state=open")

          LEN=$(echo "$PRS_JSON" | jq 'length')
          if [ "$LEN" -gt 0 ]; then
            echo "Found an existing open PR for ${OWNER}:${BRANCH}, skip creating."
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create the PR
          TITLE="chore: 同步上游 ${UPSTREAM_REPO} 更新 (${BRANCH})"
          BODY="已自动同步上游仓库 \`${UPSTREAM_REPO}\` 的更新并新建了分支。<br><br> 请人工检查并合并。"
          CREATE_RESPONSE=$(curl -s -X POST -H "Authorization: token ${PAT}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg t "$TITLE" --arg h "${OWNER}:${BRANCH}" --arg b "$BASE" --arg body "$BODY" '{title:$t, head:$h, base:$b, body:$body, maintainer_can_modify:true}')" \
            "${GITHUB_API}/repos/${REPO}/pulls")

          PR_URL=$(echo "$CREATE_RESPONSE" | jq -r '.html_url // empty')
          PR_NUMBER=$(echo "$CREATE_RESPONSE" | jq -r '.number // empty')

          if [ -n "$PR_URL" ]; then
            echo "PR created: $PR_URL"
            echo "pr_created=true" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "Failed to create PR. Response:"
            echo "$CREATE_RESPONSE"
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 1
          fi
