name: Sync Upstream

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_sync_master:
        description: '是否直接强制把下游 master 覆盖为上游 master（危险）'
        required: false
        default: 'false'
      create_pr:
        description: '如果有差异，是否创建 PR（true/false）'
        required: false
        default: 'true'

env:
  UPSTREAM_REPO: 'astrbotdevs/astrbot'
  UPSTREAM_BRANCH: 'master'
  TARGET_BRANCH: 'master'

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    # 把调度/dispatch 参数在 job 级别设为 env（便于在 if 中引用）
    env:
      CREATE_PR: ${{ github.event.inputs.create_pr || 'true' }}
      FORCE_SYNC: ${{ github.event.inputs.force_sync_master || 'false' }}

    steps:
      - name: Checkout target repository (full history, allow pushes)
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Configure git user
        run: |
          git config user.name "sync-bot"
          git config user.email "sync-bot@example.com"

      - name: Add upstream remote and fetch branches
        run: |
          UPSTREAM_URL="https://github.com/${UPSTREAM_REPO}.git"
          git remote add upstream "${UPSTREAM_URL}" || true
          git fetch --no-tags --prune upstream ${UPSTREAM_BRANCH}
          git fetch --no-tags --prune origin ${TARGET_BRANCH}

      - name: Show remotes and SHAs
        run: |
          echo "Remotes:"
          git remote -v
          echo "origin/${TARGET_BRANCH}: $(git rev-parse origin/${TARGET_BRANCH} || echo 'missing')"
          echo "upstream/${UPSTREAM_BRANCH}: $(git rev-parse upstream/${UPSTREAM_BRANCH} || echo 'missing')"
          echo "Commits upstream not in origin (count):"
          git rev-list --count origin/${TARGET_BRANCH}..upstream/${UPSTREAM_BRANCH} || echo "rev-list failed"

      - name: Check if upstream has new commits
        id: check_commits
        run: |
          NEW_COMMITS_COUNT=$(git rev-list --count origin/${TARGET_BRANCH}..upstream/${UPSTREAM_BRANCH} || echo 0)
          echo "new_commits=${NEW_COMMITS_COUNT}" >> $GITHUB_OUTPUT
          echo "Upstream -> origin diff commits: ${NEW_COMMITS_COUNT}"

      # 当发现有新提交且用户希望创建 PR 时创建分支并 push
      - name: Create branch from upstream and push
        if: ${{ steps.check_commits.outputs.new_commits != '0' && env.CREATE_PR == 'true' }}
        run: |
          BRANCH_NAME="sync-upstream-${{ github.run_id }}"
          echo "Creating branch ${BRANCH_NAME} from upstream/${UPSTREAM_BRANCH}"
          git checkout -b "${BRANCH_NAME}" upstream/${UPSTREAM_BRANCH}
          git push --set-upstream origin "${BRANCH_NAME}"
          echo "pushed branch ${BRANCH_NAME}"

      - name: Create Pull Request (if branch created)
        if: ${{ steps.check_commits.outputs.new_commits != '0' && env.CREATE_PR == 'true' }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.PAT }}
          branch: sync-upstream-${{ github.run_id }}
          base: ${{ env.TARGET_BRANCH }}
          delete-branch: true   # 调试时可先设 false
          title: 'chore: 自动同步上游更新'
          body: |
            检测到上游仓库 `${{ env.UPSTREAM_REPO }}` 有新更新，自动创建此 PR 以便人工审查与合并。
          labels: automated pr
          maintainer-can-modify: true

      # 强制覆盖 master（仅在 dispatch 时设置 force_sync_master=true 才会执行）
      - name: Force-sync master (dangerous) - optional
        if: ${{ env.FORCE_SYNC == 'true' }}
        run: |
          echo "⚠️ FORCE SYNC: Resetting origin/${TARGET_BRANCH} to upstream/${UPSTREAM_BRANCH}"
          git checkout ${TARGET_BRANCH}
          git reset --hard upstream/${UPSTREAM_BRANCH}
          git push origin ${TARGET_BRANCH} --force
          echo "Force-pushed ${TARGET_BRANCH} -> origin"

      - name: No changes - report
        if: ${{ steps.check_commits.outputs.new_commits == '0' }}
        run: |
          echo "No new commits to sync from upstream/${UPSTREAM_BRANCH} -> origin/${TARGET_BRANCH}. Nothing to do."

      - name: Final status
        run: |
          echo "Sync job finished. new_commits=${{ steps.check_commits.outputs.new_commits }}"
